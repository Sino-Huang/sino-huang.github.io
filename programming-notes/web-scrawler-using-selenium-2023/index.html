<!DOCTYPE html>
<html dir="auto" lang="en">
<head><meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
<meta content="index, follow" name="robots"/>
<title>Web Scrawler Using Selenium 2023 | Sukai Huang</title>
<meta content="" name="keywords"/>
<meta content="[TOC]

Title: Web Scrawler Using Selenium 2023
Review Date: Thu, Jun 22, 2023

Web scrawler, ticket buying as a case study
Preparation: python venv

check https://www.youtube.com/watch?v=Kg1Yvry_Ydk



1
2
3
4
5
6
7
8
9


python -m venv venv
source venv/bin/activate

# install the following using pip 
selenium==4.9.1
undetected-chromedriver&gt;=3.4.6
webdriver-manager
jupyterlab
pyopenssl



known where is the Google Chrome user file location



1
2


MAC ~/Library/Application Support/Google/Chrome
Linux ~/.config/google-chrome




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36


# load options
options = uc.ChromeOptions()
options.page_load_strategy = 'eager'
# options.add_argument(&quot;--auto-open-devtools-for-tabs&quot;) # help to avoid cloudfare human verify check
options.add_argument(&quot;--disable-popup-blocking&quot;)
options.add_argument(&quot;--window-size=800,600&quot;)
options.add_argument(&quot;--start-maximized&quot;)
options.add_argument('--disable-gpu')
options.add_argument(&quot;--no-sandbox&quot;)
options.add_argument(&quot;--disable-setuid-sandbox&quot;)
options.add_argument(&quot;--disable-extensions&quot;)
options.add_argument('--disable-application-cache')
options.add_argument(&quot;--disable-dev-shm-usage&quot;)
if HEADLESS:
    options.add_argument(&quot;--headless=new&quot;)
    
try:
    # check os system
    if os.name == &quot;posix&quot;:
        time.sleep(3) # wait for chrome profile to be ready
        driver = uc.Chrome(options=options,
                        driver_executable_path=ChromeDriverManager().install(),
                        user_data_dir=chrome_profile_path,
                        # version_main=VERSION,
                        user_multi_procs=True)
    elif os.name == &quot;nt&quot;:
        time.sleep(3) # wait for chrome profile to be ready
        options.add_argument(f&quot;--user-data-dir={chrome_profile_path}&quot;)
        driver = uc.Chrome(options=options,
                            driver_executable_path=ChromeDriverManager().install(),
                        #    driver_executable_path=os.path.join(os.path.abspath(os.getcwd()), 'chromedriver-win64/chromedriver-win64/chromedriver.exe'),
                           user_multi_procs=True,
                           )
    else:
        raise Exception(&quot;Unknown OS&quot;)
    driver.implicitly_wait(5)


Some known issue about selenium

to avoid memory leak in multiprocessing env, please import the driver inside the subprocess (e.g., inside the function)
wait until presence is very slow, try the sleepy find element
we need to setup logging queue to avoid crash for multiprocessing logging module
list(tqdm(pool.imap(*), total = len(*))) is a good way to record multiprocess progress

Utils functions

sleep find element



 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28


def sleepy_find_element(by, query, attempt_count :int =30, sleep_duration =0.3):
    '''
    Finds the web element using the locator and query.

    This function attempts to find the element multiple times with a specified
    sleep duration between attempts. If the element is found, the function returns the element.

    Args:
        by (selenium.webdriver.common.by.By): The method used to locate the element.
        query (str): The query string to locate the element.
        attempt_count (int, optional): The number of attempts to find the element. Default: 20.
        sleep_duration (int, optional): The duration to sleep between attempts. Default: 1.

    Returns:
        selenium.webdriver.remote.webelement.WebElement: Web element or None if not found.
    '''
    global browser
    for _count in range(attempt_count):
        item = browser.find_elements(by, query)
        if len(item) &gt; 0:
            item = item[0]
            logging.info(f'Element {query} has found')
            break
        logging.info(f'Element {query} is not present, attempt: {_count+1}')
        time.sleep(sleep_duration)
    if item is list:
        logging.warning(&quot;Element not find!&quot;)
    return item



move to element



1
2
3
4
5
6
7
8


# import Action chains
from selenium.webdriver import ActionChains
#element
source = driver.find_element_by_id(&quot;name&quot;)
#action chain object
action = ActionChains(driver)
# move to element operation
action.move_to_element(source).click().perform()



useful imports



 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15


from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, NoSuchElementException
import logging
from pathlib import Path
from tqdm.auto import tqdm
import os
import pickle
import csv
import time
import threading
from glob import glob
import argparse


lxml html xpath with requests

used for requests (simpler and faster in some cases)



 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19


from lxml import html

response = requests.get(complete_url)
content = response.content
tree = html.fromstring(content) # read byte content


# print(&quot;start loading&quot;)
# latitude 
latitude_xp = '//h3[contains(text(), &quot;Coordinates&quot;)]/following-sibling::p[contains(text(), &quot;Latitude&quot;)]'
latitude_ele = tree.xpath(latitude_xp)
if latitude_ele:
    latitude_ele = latitude_ele[0]
    latitude_info = latitude_ele.text_content().strip().split(&quot;Latitude: &quot;)[1]
    # print('latitude_info', latitude_info)
    temp = dict()
    temp['latitude'] = latitude_info
else:
    return 



text_content() will get all the text in the node, which is same as .text in selenium

multiprocessing with tqdm


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47


from tqdm.contrib.concurrent import process_map
from multiprocessing import Pool, Process, Manager, Lock


  manager = Manager() # Manager dictionary must be used for multiprocessing
  # m_saved_postcode_lst = manager.list(saved_postcode_lst)
  # m_no_data_lst = manager.list(no_data_lst)
  m_chromelock = manager.Lock()
  m_nodatalock = manager.Lock()
  m_savedpstcdlock = manager.Lock()

  m_profile_path_list = manager.list(profile_path_list)



  # %%
  postcode_list_chunks = [postcode_list[x:x+CHUNK_SIZE] for x in range(0, len(postcode_list), CHUNK_SIZE)]

  # %%
  args = [(chunk, m_chromelock,m_nodatalock,m_savedpstcdlock, m_profile_path_list, loggername, loggingfile, data_index) for chunk in postcode_list_chunks]

  try:
      with mp.Pool(PROCESS_NUM) as pool:
          results = list(logging_tqdm(pool.imap(helperf, args, chunksize=1), total=len(args),
                                      loggername=loggername,
                                      loggingfile=loggingfile,
                                      desc=&quot;Progress Status in Main Process&quot;))

  except Exception as e:
      logger.error(e)
      raise e
  finally:
      active_children = mp.active_children()
      for p in active_children:
          p.kill()
          p.join()
      logger.info(&quot;Killing all processes&quot;)

# IMPORTANT we must attach dict to the manager dict, nest dict update is banned in multiprocessing

temp = {
  &quot;United States&quot;: &quot;New York&quot;, 
  &quot;Italy&quot;: &quot;Naples&quot;, 
  &quot;England&quot;: &quot;London&quot;
}
postcode_info_dict[postcode] = temp # OK
postcode_info_dict[postcode]['United States'] = &quot;New York&quot; # BAD


" name="description"/>
<meta content="Sukai Huang" name="author"/>
<link href="https://sino-huang.github.io/programming-notes/web-scrawler-using-selenium-2023/" rel="canonical"/>
<meta content="IFgzhtDTVCjONQMwQsBfuf0ZyHdzUR5WFYzbWsf2Gf8" name="google-site-verification"/>
<link as="style" crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet"/>
<link href="https://sino-huang.github.io/favicon.ico" rel="icon"/>
<link href="https://sino-huang.github.io/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="https://sino-huang.github.io/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="https://sino-huang.github.io/apple-touch-icon.png" rel="apple-touch-icon"/>
<link href="https://sino-huang.github.io/safari-pinned-tab.svg" rel="mask-icon"/>
<meta content="#2e2e33" name="theme-color"/>
<meta content="#2e2e33" name="msapplication-TileColor"/>
<link href="https://sino-huang.github.io/programming-notes/web-scrawler-using-selenium-2023/" hreflang="en" rel="alternate"/>
<noscript>
<style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
<style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/katex@0.16.18/dist/katex.min.css" integrity="sha384-veTAhWILPOotXm+kbR5uY7dRamYLJf58I7P+hJhjeuc7hsMAkJHTsPahAl0hBST0" rel="stylesheet"/>
<script crossorigin="anonymous" defer="" integrity="sha384-v6mkHYHfY/4BWq54f7lQAdtIsoZZIByznQ3ZqN38OL4KCsrxo31SLlPiak7cj/Mg" src="https://cdn.jsdelivr.net/npm/katex@0.16.18/dist/katex.min.js"></script>
<script crossorigin="anonymous" defer="" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" src="https://cdn.jsdelivr.net/npm/katex@0.16.18/dist/contrib/auto-render.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          
          
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          
          throwOnError : false
        });
    });
</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-TTFTV1EWH5"></script>
<script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-TTFTV1EWH5');
        }
      </script><meta content="https://sino-huang.github.io/programming-notes/web-scrawler-using-selenium-2023/" property="og:url"/>
<meta content="Sukai Huang" property="og:site_name"/>
<meta content="Web Scrawler Using Selenium 2023" property="og:title"/>
<meta content="[TOC]
Title: Web Scrawler Using Selenium 2023 Review Date: Thu, Jun 22, 2023 Web scrawler, ticket buying as a case study Preparation: python venv check https://www.youtube.com/watch?v=Kg1Yvry_Ydk 1 2 3 4 5 6 7 8 9 python -m venv venv source venv/bin/activate # install the following using pip selenium==4.9.1 undetected-chromedriver&gt;=3.4.6 webdriver-manager jupyterlab pyopenssl known where is the Google Chrome user file location 1 2 MAC ~/Library/Application Support/Google/Chrome Linux ~/.config/google-chrome 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 # load options options = uc.ChromeOptions() options.page_load_strategy = 'eager' # options.add_argument(&quot;--auto-open-devtools-for-tabs&quot;) # help to avoid cloudfare human verify check options.add_argument(&quot;--disable-popup-blocking&quot;) options.add_argument(&quot;--window-size=800,600&quot;) options.add_argument(&quot;--start-maximized&quot;) options.add_argument('--disable-gpu') options.add_argument(&quot;--no-sandbox&quot;) options.add_argument(&quot;--disable-setuid-sandbox&quot;) options.add_argument(&quot;--disable-extensions&quot;) options.add_argument('--disable-application-cache') options.add_argument(&quot;--disable-dev-shm-usage&quot;) if HEADLESS: options.add_argument(&quot;--headless=new&quot;) try: # check os system if os.name == &quot;posix&quot;: time.sleep(3) # wait for chrome profile to be ready driver = uc.Chrome(options=options, driver_executable_path=ChromeDriverManager().install(), user_data_dir=chrome_profile_path, # version_main=VERSION, user_multi_procs=True) elif os.name == &quot;nt&quot;: time.sleep(3) # wait for chrome profile to be ready options.add_argument(f&quot;--user-data-dir={chrome_profile_path}&quot;) driver = uc.Chrome(options=options, driver_executable_path=ChromeDriverManager().install(), # driver_executable_path=os.path.join(os.path.abspath(os.getcwd()), 'chromedriver-win64/chromedriver-win64/chromedriver.exe'), user_multi_procs=True, ) else: raise Exception(&quot;Unknown OS&quot;) driver.implicitly_wait(5) Some known issue about selenium to avoid memory leak in multiprocessing env, please import the driver inside the subprocess (e.g., inside the function) wait until presence is very slow, try the sleepy find element we need to setup logging queue to avoid crash for multiprocessing logging module list(tqdm(pool.imap(*), total = len(*))) is a good way to record multiprocess progress Utils functions sleep find element 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 def sleepy_find_element(by, query, attempt_count :int =30, sleep_duration =0.3): ''' Finds the web element using the locator and query. This function attempts to find the element multiple times with a specified sleep duration between attempts. If the element is found, the function returns the element. Args: by (selenium.webdriver.common.by.By): The method used to locate the element. query (str): The query string to locate the element. attempt_count (int, optional): The number of attempts to find the element. Default: 20. sleep_duration (int, optional): The duration to sleep between attempts. Default: 1. Returns: selenium.webdriver.remote.webelement.WebElement: Web element or None if not found. ''' global browser for _count in range(attempt_count): item = browser.find_elements(by, query) if len(item) &gt; 0: item = item[0] logging.info(f'Element {query} has found') break logging.info(f'Element {query} is not present, attempt: {_count+1}') time.sleep(sleep_duration) if item is list: logging.warning(&quot;Element not find!&quot;) return item move to element 1 2 3 4 5 6 7 8 # import Action chains from selenium.webdriver import ActionChains #element source = driver.find_element_by_id(&quot;name&quot;) #action chain object action = ActionChains(driver) # move to element operation action.move_to_element(source).click().perform() useful imports 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from selenium.webdriver.common.by import By from selenium.webdriver.common.keys import Keys from selenium.webdriver.support.wait import WebDriverWait from selenium.webdriver.support import expected_conditions as EC from selenium.common.exceptions import TimeoutException, NoSuchElementException import logging from pathlib import Path from tqdm.auto import tqdm import os import pickle import csv import time import threading from glob import glob import argparse lxml html xpath with requests used for requests (simpler and faster in some cases) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 from lxml import html response = requests.get(complete_url) content = response.content tree = html.fromstring(content) # read byte content # print(&quot;start loading&quot;) # latitude latitude_xp = '//h3[contains(text(), &quot;Coordinates&quot;)]/following-sibling::p[contains(text(), &quot;Latitude&quot;)]' latitude_ele = tree.xpath(latitude_xp) if latitude_ele: latitude_ele = latitude_ele[0] latitude_info = latitude_ele.text_content().strip().split(&quot;Latitude: &quot;)[1] # print('latitude_info', latitude_info) temp = dict() temp['latitude'] = latitude_info else: return text_content() will get all the text in the node, which is same as .text in selenium multiprocessing with tqdm 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 from tqdm.contrib.concurrent import process_map from multiprocessing import Pool, Process, Manager, Lock manager = Manager() # Manager dictionary must be used for multiprocessing # m_saved_postcode_lst = manager.list(saved_postcode_lst) # m_no_data_lst = manager.list(no_data_lst) m_chromelock = manager.Lock() m_nodatalock = manager.Lock() m_savedpstcdlock = manager.Lock() m_profile_path_list = manager.list(profile_path_list) # %% postcode_list_chunks = [postcode_list[x:x+CHUNK_SIZE] for x in range(0, len(postcode_list), CHUNK_SIZE)] # %% args = [(chunk, m_chromelock,m_nodatalock,m_savedpstcdlock, m_profile_path_list, loggername, loggingfile, data_index) for chunk in postcode_list_chunks] try: with mp.Pool(PROCESS_NUM) as pool: results = list(logging_tqdm(pool.imap(helperf, args, chunksize=1), total=len(args), loggername=loggername, loggingfile=loggingfile, desc=&quot;Progress Status in Main Process&quot;)) except Exception as e: logger.error(e) raise e finally: active_children = mp.active_children() for p in active_children: p.kill() p.join() logger.info(&quot;Killing all processes&quot;) # IMPORTANT we must attach dict to the manager dict, nest dict update is banned in multiprocessing temp = { &quot;United States&quot;: &quot;New York&quot;, &quot;Italy&quot;: &quot;Naples&quot;, &quot;England&quot;: &quot;London&quot; } postcode_info_dict[postcode] = temp # OK postcode_info_dict[postcode]['United States'] = &quot;New York&quot; # BAD " property="og:description"/>
<meta content="en" property="og:locale"/>
<meta content="article" property="og:type"/>
<meta content="programming-notes" property="article:section"/>
<meta content="2023-06-22T22:38:28+10:00" property="article:published_time"/>
<meta content="2023-06-22T22:38:28+10:00" property="article:modified_time"/>
<meta content="https://sino-huang.github.io/posts/web-scrawler-using-selenium-2023/image-assets/cover.png" property="og:image"/>
<meta content="summary_large_image" name="twitter:card"/>
<meta content="https://sino-huang.github.io/posts/web-scrawler-using-selenium-2023/image-assets/cover.png" name="twitter:image"/>
<meta content="Web Scrawler Using Selenium 2023" name="twitter:title"/>
<meta content="[TOC]

Title: Web Scrawler Using Selenium 2023
Review Date: Thu, Jun 22, 2023

Web scrawler, ticket buying as a case study
Preparation: python venv

check https://www.youtube.com/watch?v=Kg1Yvry_Ydk



1
2
3
4
5
6
7
8
9


python -m venv venv
source venv/bin/activate

# install the following using pip 
selenium==4.9.1
undetected-chromedriver&gt;=3.4.6
webdriver-manager
jupyterlab
pyopenssl



known where is the Google Chrome user file location



1
2


MAC ~/Library/Application Support/Google/Chrome
Linux ~/.config/google-chrome




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36


# load options
options = uc.ChromeOptions()
options.page_load_strategy = 'eager'
# options.add_argument(&quot;--auto-open-devtools-for-tabs&quot;) # help to avoid cloudfare human verify check
options.add_argument(&quot;--disable-popup-blocking&quot;)
options.add_argument(&quot;--window-size=800,600&quot;)
options.add_argument(&quot;--start-maximized&quot;)
options.add_argument('--disable-gpu')
options.add_argument(&quot;--no-sandbox&quot;)
options.add_argument(&quot;--disable-setuid-sandbox&quot;)
options.add_argument(&quot;--disable-extensions&quot;)
options.add_argument('--disable-application-cache')
options.add_argument(&quot;--disable-dev-shm-usage&quot;)
if HEADLESS:
    options.add_argument(&quot;--headless=new&quot;)
    
try:
    # check os system
    if os.name == &quot;posix&quot;:
        time.sleep(3) # wait for chrome profile to be ready
        driver = uc.Chrome(options=options,
                        driver_executable_path=ChromeDriverManager().install(),
                        user_data_dir=chrome_profile_path,
                        # version_main=VERSION,
                        user_multi_procs=True)
    elif os.name == &quot;nt&quot;:
        time.sleep(3) # wait for chrome profile to be ready
        options.add_argument(f&quot;--user-data-dir={chrome_profile_path}&quot;)
        driver = uc.Chrome(options=options,
                            driver_executable_path=ChromeDriverManager().install(),
                        #    driver_executable_path=os.path.join(os.path.abspath(os.getcwd()), 'chromedriver-win64/chromedriver-win64/chromedriver.exe'),
                           user_multi_procs=True,
                           )
    else:
        raise Exception(&quot;Unknown OS&quot;)
    driver.implicitly_wait(5)


Some known issue about selenium

to avoid memory leak in multiprocessing env, please import the driver inside the subprocess (e.g., inside the function)
wait until presence is very slow, try the sleepy find element
we need to setup logging queue to avoid crash for multiprocessing logging module
list(tqdm(pool.imap(*), total = len(*))) is a good way to record multiprocess progress

Utils functions

sleep find element



 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28


def sleepy_find_element(by, query, attempt_count :int =30, sleep_duration =0.3):
    '''
    Finds the web element using the locator and query.

    This function attempts to find the element multiple times with a specified
    sleep duration between attempts. If the element is found, the function returns the element.

    Args:
        by (selenium.webdriver.common.by.By): The method used to locate the element.
        query (str): The query string to locate the element.
        attempt_count (int, optional): The number of attempts to find the element. Default: 20.
        sleep_duration (int, optional): The duration to sleep between attempts. Default: 1.

    Returns:
        selenium.webdriver.remote.webelement.WebElement: Web element or None if not found.
    '''
    global browser
    for _count in range(attempt_count):
        item = browser.find_elements(by, query)
        if len(item) &gt; 0:
            item = item[0]
            logging.info(f'Element {query} has found')
            break
        logging.info(f'Element {query} is not present, attempt: {_count+1}')
        time.sleep(sleep_duration)
    if item is list:
        logging.warning(&quot;Element not find!&quot;)
    return item



move to element



1
2
3
4
5
6
7
8


# import Action chains
from selenium.webdriver import ActionChains
#element
source = driver.find_element_by_id(&quot;name&quot;)
#action chain object
action = ActionChains(driver)
# move to element operation
action.move_to_element(source).click().perform()



useful imports



 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15


from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, NoSuchElementException
import logging
from pathlib import Path
from tqdm.auto import tqdm
import os
import pickle
import csv
import time
import threading
from glob import glob
import argparse


lxml html xpath with requests

used for requests (simpler and faster in some cases)



 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19


from lxml import html

response = requests.get(complete_url)
content = response.content
tree = html.fromstring(content) # read byte content


# print(&quot;start loading&quot;)
# latitude 
latitude_xp = '//h3[contains(text(), &quot;Coordinates&quot;)]/following-sibling::p[contains(text(), &quot;Latitude&quot;)]'
latitude_ele = tree.xpath(latitude_xp)
if latitude_ele:
    latitude_ele = latitude_ele[0]
    latitude_info = latitude_ele.text_content().strip().split(&quot;Latitude: &quot;)[1]
    # print('latitude_info', latitude_info)
    temp = dict()
    temp['latitude'] = latitude_info
else:
    return 



text_content() will get all the text in the node, which is same as .text in selenium

multiprocessing with tqdm


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47


from tqdm.contrib.concurrent import process_map
from multiprocessing import Pool, Process, Manager, Lock


  manager = Manager() # Manager dictionary must be used for multiprocessing
  # m_saved_postcode_lst = manager.list(saved_postcode_lst)
  # m_no_data_lst = manager.list(no_data_lst)
  m_chromelock = manager.Lock()
  m_nodatalock = manager.Lock()
  m_savedpstcdlock = manager.Lock()

  m_profile_path_list = manager.list(profile_path_list)



  # %%
  postcode_list_chunks = [postcode_list[x:x+CHUNK_SIZE] for x in range(0, len(postcode_list), CHUNK_SIZE)]

  # %%
  args = [(chunk, m_chromelock,m_nodatalock,m_savedpstcdlock, m_profile_path_list, loggername, loggingfile, data_index) for chunk in postcode_list_chunks]

  try:
      with mp.Pool(PROCESS_NUM) as pool:
          results = list(logging_tqdm(pool.imap(helperf, args, chunksize=1), total=len(args),
                                      loggername=loggername,
                                      loggingfile=loggingfile,
                                      desc=&quot;Progress Status in Main Process&quot;))

  except Exception as e:
      logger.error(e)
      raise e
  finally:
      active_children = mp.active_children()
      for p in active_children:
          p.kill()
          p.join()
      logger.info(&quot;Killing all processes&quot;)

# IMPORTANT we must attach dict to the manager dict, nest dict update is banned in multiprocessing

temp = {
  &quot;United States&quot;: &quot;New York&quot;, 
  &quot;Italy&quot;: &quot;Naples&quot;, 
  &quot;England&quot;: &quot;London&quot;
}
postcode_info_dict[postcode] = temp # OK
postcode_info_dict[postcode]['United States'] = &quot;New York&quot; # BAD


" name="twitter:description"/>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Programming-Notes",
      "item": "https://sino-huang.github.io/programming-notes/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Web Scrawler Using Selenium 2023",
      "item": "https://sino-huang.github.io/programming-notes/web-scrawler-using-selenium-2023/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Web Scrawler Using Selenium 2023",
  "name": "Web Scrawler Using Selenium 2023",
  "description": "[TOC]\nTitle: Web Scrawler Using Selenium 2023 Review Date: Thu, Jun 22, 2023 Web scrawler, ticket buying as a case study Preparation: python venv check https://www.youtube.com/watch?v=Kg1Yvry_Ydk 1 2 3 4 5 6 7 8 9 python -m venv venv source venv/bin/activate # install the following using pip selenium==4.9.1 undetected-chromedriver\u0026gt;=3.4.6 webdriver-manager jupyterlab pyopenssl known where is the Google Chrome user file location 1 2 MAC ~/Library/Application Support/Google/Chrome Linux ~/.config/google-chrome 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 # load options options = uc.ChromeOptions() options.page_load_strategy = \u0026#39;eager\u0026#39; # options.add_argument(\u0026#34;--auto-open-devtools-for-tabs\u0026#34;) # help to avoid cloudfare human verify check options.add_argument(\u0026#34;--disable-popup-blocking\u0026#34;) options.add_argument(\u0026#34;--window-size=800,600\u0026#34;) options.add_argument(\u0026#34;--start-maximized\u0026#34;) options.add_argument(\u0026#39;--disable-gpu\u0026#39;) options.add_argument(\u0026#34;--no-sandbox\u0026#34;) options.add_argument(\u0026#34;--disable-setuid-sandbox\u0026#34;) options.add_argument(\u0026#34;--disable-extensions\u0026#34;) options.add_argument(\u0026#39;--disable-application-cache\u0026#39;) options.add_argument(\u0026#34;--disable-dev-shm-usage\u0026#34;) if HEADLESS: options.add_argument(\u0026#34;--headless=new\u0026#34;) try: # check os system if os.name == \u0026#34;posix\u0026#34;: time.sleep(3) # wait for chrome profile to be ready driver = uc.Chrome(options=options, driver_executable_path=ChromeDriverManager().install(), user_data_dir=chrome_profile_path, # version_main=VERSION, user_multi_procs=True) elif os.name == \u0026#34;nt\u0026#34;: time.sleep(3) # wait for chrome profile to be ready options.add_argument(f\u0026#34;--user-data-dir={chrome_profile_path}\u0026#34;) driver = uc.Chrome(options=options, driver_executable_path=ChromeDriverManager().install(), # driver_executable_path=os.path.join(os.path.abspath(os.getcwd()), \u0026#39;chromedriver-win64/chromedriver-win64/chromedriver.exe\u0026#39;), user_multi_procs=True, ) else: raise Exception(\u0026#34;Unknown OS\u0026#34;) driver.implicitly_wait(5) Some known issue about selenium to avoid memory leak in multiprocessing env, please import the driver inside the subprocess (e.g., inside the function) wait until presence is very slow, try the sleepy find element we need to setup logging queue to avoid crash for multiprocessing logging module list(tqdm(pool.imap(*), total = len(*))) is a good way to record multiprocess progress Utils functions sleep find element 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 def sleepy_find_element(by, query, attempt_count :int =30, sleep_duration =0.3): \u0026#39;\u0026#39;\u0026#39; Finds the web element using the locator and query. This function attempts to find the element multiple times with a specified sleep duration between attempts. If the element is found, the function returns the element. Args: by (selenium.webdriver.common.by.By): The method used to locate the element. query (str): The query string to locate the element. attempt_count (int, optional): The number of attempts to find the element. Default: 20. sleep_duration (int, optional): The duration to sleep between attempts. Default: 1. Returns: selenium.webdriver.remote.webelement.WebElement: Web element or None if not found. \u0026#39;\u0026#39;\u0026#39; global browser for _count in range(attempt_count): item = browser.find_elements(by, query) if len(item) \u0026gt; 0: item = item[0] logging.info(f\u0026#39;Element {query} has found\u0026#39;) break logging.info(f\u0026#39;Element {query} is not present, attempt: {_count+1}\u0026#39;) time.sleep(sleep_duration) if item is list: logging.warning(\u0026#34;Element not find!\u0026#34;) return item move to element 1 2 3 4 5 6 7 8 # import Action chains from selenium.webdriver import ActionChains #element source = driver.find_element_by_id(\u0026#34;name\u0026#34;) #action chain object action = ActionChains(driver) # move to element operation action.move_to_element(source).click().perform() useful imports 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from selenium.webdriver.common.by import By from selenium.webdriver.common.keys import Keys from selenium.webdriver.support.wait import WebDriverWait from selenium.webdriver.support import expected_conditions as EC from selenium.common.exceptions import TimeoutException, NoSuchElementException import logging from pathlib import Path from tqdm.auto import tqdm import os import pickle import csv import time import threading from glob import glob import argparse lxml html xpath with requests used for requests (simpler and faster in some cases) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 from lxml import html response = requests.get(complete_url) content = response.content tree = html.fromstring(content) # read byte content # print(\u0026#34;start loading\u0026#34;) # latitude latitude_xp = \u0026#39;//h3[contains(text(), \u0026#34;Coordinates\u0026#34;)]/following-sibling::p[contains(text(), \u0026#34;Latitude\u0026#34;)]\u0026#39; latitude_ele = tree.xpath(latitude_xp) if latitude_ele: latitude_ele = latitude_ele[0] latitude_info = latitude_ele.text_content().strip().split(\u0026#34;Latitude: \u0026#34;)[1] # print(\u0026#39;latitude_info\u0026#39;, latitude_info) temp = dict() temp[\u0026#39;latitude\u0026#39;] = latitude_info else: return text_content() will get all the text in the node, which is same as .text in selenium multiprocessing with tqdm 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 from tqdm.contrib.concurrent import process_map from multiprocessing import Pool, Process, Manager, Lock manager = Manager() # Manager dictionary must be used for multiprocessing # m_saved_postcode_lst = manager.list(saved_postcode_lst) # m_no_data_lst = manager.list(no_data_lst) m_chromelock = manager.Lock() m_nodatalock = manager.Lock() m_savedpstcdlock = manager.Lock() m_profile_path_list = manager.list(profile_path_list) # %% postcode_list_chunks = [postcode_list[x:x+CHUNK_SIZE] for x in range(0, len(postcode_list), CHUNK_SIZE)] # %% args = [(chunk, m_chromelock,m_nodatalock,m_savedpstcdlock, m_profile_path_list, loggername, loggingfile, data_index) for chunk in postcode_list_chunks] try: with mp.Pool(PROCESS_NUM) as pool: results = list(logging_tqdm(pool.imap(helperf, args, chunksize=1), total=len(args), loggername=loggername, loggingfile=loggingfile, desc=\u0026#34;Progress Status in Main Process\u0026#34;)) except Exception as e: logger.error(e) raise e finally: active_children = mp.active_children() for p in active_children: p.kill() p.join() logger.info(\u0026#34;Killing all processes\u0026#34;) # IMPORTANT we must attach dict to the manager dict, nest dict update is banned in multiprocessing temp = { \u0026#34;United States\u0026#34;: \u0026#34;New York\u0026#34;, \u0026#34;Italy\u0026#34;: \u0026#34;Naples\u0026#34;, \u0026#34;England\u0026#34;: \u0026#34;London\u0026#34; } postcode_info_dict[postcode] = temp # OK postcode_info_dict[postcode][\u0026#39;United States\u0026#39;] = \u0026#34;New York\u0026#34; # BAD ",
  "keywords": [
    
  ],
  "articleBody": "[TOC]\nTitle: Web Scrawler Using Selenium 2023 Review Date: Thu, Jun 22, 2023 Web scrawler, ticket buying as a case study Preparation: python venv check https://www.youtube.com/watch?v=Kg1Yvry_Ydk 1 2 3 4 5 6 7 8 9 python -m venv venv source venv/bin/activate # install the following using pip selenium==4.9.1 undetected-chromedriver\u003e=3.4.6 webdriver-manager jupyterlab pyopenssl known where is the Google Chrome user file location 1 2 MAC ~/Library/Application Support/Google/Chrome Linux ~/.config/google-chrome 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 # load options options = uc.ChromeOptions() options.page_load_strategy = 'eager' # options.add_argument(\"--auto-open-devtools-for-tabs\") # help to avoid cloudfare human verify check options.add_argument(\"--disable-popup-blocking\") options.add_argument(\"--window-size=800,600\") options.add_argument(\"--start-maximized\") options.add_argument('--disable-gpu') options.add_argument(\"--no-sandbox\") options.add_argument(\"--disable-setuid-sandbox\") options.add_argument(\"--disable-extensions\") options.add_argument('--disable-application-cache') options.add_argument(\"--disable-dev-shm-usage\") if HEADLESS: options.add_argument(\"--headless=new\") try: # check os system if os.name == \"posix\": time.sleep(3) # wait for chrome profile to be ready driver = uc.Chrome(options=options, driver_executable_path=ChromeDriverManager().install(), user_data_dir=chrome_profile_path, # version_main=VERSION, user_multi_procs=True) elif os.name == \"nt\": time.sleep(3) # wait for chrome profile to be ready options.add_argument(f\"--user-data-dir={chrome_profile_path}\") driver = uc.Chrome(options=options, driver_executable_path=ChromeDriverManager().install(), # driver_executable_path=os.path.join(os.path.abspath(os.getcwd()), 'chromedriver-win64/chromedriver-win64/chromedriver.exe'), user_multi_procs=True, ) else: raise Exception(\"Unknown OS\") driver.implicitly_wait(5) Some known issue about selenium to avoid memory leak in multiprocessing env, please import the driver inside the subprocess (e.g., inside the function) wait until presence is very slow, try the sleepy find element we need to setup logging queue to avoid crash for multiprocessing logging module list(tqdm(pool.imap(*), total = len(*))) is a good way to record multiprocess progress Utils functions sleep find element 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 def sleepy_find_element(by, query, attempt_count :int =30, sleep_duration =0.3): ''' Finds the web element using the locator and query. This function attempts to find the element multiple times with a specified sleep duration between attempts. If the element is found, the function returns the element. Args: by (selenium.webdriver.common.by.By): The method used to locate the element. query (str): The query string to locate the element. attempt_count (int, optional): The number of attempts to find the element. Default: 20. sleep_duration (int, optional): The duration to sleep between attempts. Default: 1. Returns: selenium.webdriver.remote.webelement.WebElement: Web element or None if not found. ''' global browser for _count in range(attempt_count): item = browser.find_elements(by, query) if len(item) \u003e 0: item = item[0] logging.info(f'Element {query} has found') break logging.info(f'Element {query} is not present, attempt: {_count+1}') time.sleep(sleep_duration) if item is list: logging.warning(\"Element not find!\") return item move to element 1 2 3 4 5 6 7 8 # import Action chains from selenium.webdriver import ActionChains #element source = driver.find_element_by_id(\"name\") #action chain object action = ActionChains(driver) # move to element operation action.move_to_element(source).click().perform() useful imports 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from selenium.webdriver.common.by import By from selenium.webdriver.common.keys import Keys from selenium.webdriver.support.wait import WebDriverWait from selenium.webdriver.support import expected_conditions as EC from selenium.common.exceptions import TimeoutException, NoSuchElementException import logging from pathlib import Path from tqdm.auto import tqdm import os import pickle import csv import time import threading from glob import glob import argparse lxml html xpath with requests used for requests (simpler and faster in some cases) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 from lxml import html response = requests.get(complete_url) content = response.content tree = html.fromstring(content) # read byte content # print(\"start loading\") # latitude latitude_xp = '//h3[contains(text(), \"Coordinates\")]/following-sibling::p[contains(text(), \"Latitude\")]' latitude_ele = tree.xpath(latitude_xp) if latitude_ele: latitude_ele = latitude_ele[0] latitude_info = latitude_ele.text_content().strip().split(\"Latitude: \")[1] # print('latitude_info', latitude_info) temp = dict() temp['latitude'] = latitude_info else: return text_content() will get all the text in the node, which is same as .text in selenium multiprocessing with tqdm 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 from tqdm.contrib.concurrent import process_map from multiprocessing import Pool, Process, Manager, Lock manager = Manager() # Manager dictionary must be used for multiprocessing # m_saved_postcode_lst = manager.list(saved_postcode_lst) # m_no_data_lst = manager.list(no_data_lst) m_chromelock = manager.Lock() m_nodatalock = manager.Lock() m_savedpstcdlock = manager.Lock() m_profile_path_list = manager.list(profile_path_list) # %% postcode_list_chunks = [postcode_list[x:x+CHUNK_SIZE] for x in range(0, len(postcode_list), CHUNK_SIZE)] # %% args = [(chunk, m_chromelock,m_nodatalock,m_savedpstcdlock, m_profile_path_list, loggername, loggingfile, data_index) for chunk in postcode_list_chunks] try: with mp.Pool(PROCESS_NUM) as pool: results = list(logging_tqdm(pool.imap(helperf, args, chunksize=1), total=len(args), loggername=loggername, loggingfile=loggingfile, desc=\"Progress Status in Main Process\")) except Exception as e: logger.error(e) raise e finally: active_children = mp.active_children() for p in active_children: p.kill() p.join() logger.info(\"Killing all processes\") # IMPORTANT we must attach dict to the manager dict, nest dict update is banned in multiprocessing temp = { \"United States\": \"New York\", \"Italy\": \"Naples\", \"England\": \"London\" } postcode_info_dict[postcode] = temp # OK postcode_info_dict[postcode]['United States'] = \"New York\" # BAD ",
  "wordCount" : "813",
  "inLanguage": "en",
  "image":"https://sino-huang.github.io/posts/web-scrawler-using-selenium-2023/image-assets/cover.png","datePublished": "2023-06-22T22:38:28+10:00",
  "dateModified": "2023-06-22T22:38:28+10:00",
  "author":{
    "@type": "Person",
    "name": "Sukai Huang"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://sino-huang.github.io/programming-notes/web-scrawler-using-selenium-2023/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Sukai Huang",
    "logo": {
      "@type": "ImageObject",
      "url": "https://sino-huang.github.io/favicon.ico"
    }
  }
}
</script>
</head>
<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<header class="header">
<nav class="nav">
<div class="logo">
<a accesskey="h" href="https://sino-huang.github.io/" title="Sukai Huang (Alt + H)">Sukai Huang</a>
<div class="logo-switches">
<button accesskey="t" id="theme-toggle" title="(Alt + T)">
<svg fill="none" height="18" id="moon" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
</svg>
<svg fill="none" height="18" id="sun" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="5"></circle>
<line x1="12" x2="12" y1="1" y2="3"></line>
<line x1="12" x2="12" y1="21" y2="23"></line>
<line x1="4.22" x2="5.64" y1="4.22" y2="5.64"></line>
<line x1="18.36" x2="19.78" y1="18.36" y2="19.78"></line>
<line x1="1" x2="3" y1="12" y2="12"></line>
<line x1="21" x2="23" y1="12" y2="12"></line>
<line x1="4.22" x2="5.64" y1="19.78" y2="18.36"></line>
<line x1="18.36" x2="19.78" y1="5.64" y2="4.22"></line>
</svg>
</button>
</div>
</div>
<ul id="menu">
<li>
<a href="https://sino-huang.github.io/biography/" title="Biography">
<span>Biography</span>
</a>
</li>
<li>
<a href="https://sino-huang.github.io/archives" title="Archive">
<span>Archive</span>
</a>
</li>
<li>
<a href="https://sino-huang.github.io/tags/" title="Tags">
<span>Tags</span>
</a>
</li>
<li>
<a href="https://sino-huang.github.io/categories/" title="Categories">
<span>Categories</span>
</a>
</li>
<li>
<a accesskey="/" href="https://sino-huang.github.io/search/" title="Search (Alt + /)">
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class="main">
<article class="post-single">
<header class="post-header">
<div class="breadcrumbs"><a href="https://sino-huang.github.io/">Home</a> » <a href="https://sino-huang.github.io/programming-notes/">Programming-Notes</a></div>
<h1 class="post-title entry-hint-parent">
      Web Scrawler Using Selenium 2023
    </h1>
<div class="post-meta"><span title="2023-06-22 22:38:28 +1000 AEST">June 22, 2023</span> · 4 min · 813 words · Sukai Huang | <a href="mailto:sukaih@student.unimelb.edu.au/programming-notes/web-scrawler-using-selenium-2023/index.md" rel="noopener noreferrer" target="_blank">Submit a report</a>
</div>
</header>
<figure class="entry-cover"><img alt="" loading="eager" src="https://sino-huang.github.io/posts/web-scrawler-using-selenium-2023/image-assets/cover.png"/>
<p><text></text></p>
</figure><div class="toc">
<details>
<summary accesskey="c" title="(Alt + C)">
<span class="details">Table of Contents</span>
</summary>
<div class="inner"><ul>
<li>
<a aria-label="Web scrawler, ticket buying as a case study" href="#web-scrawler-ticket-buying-as-a-case-study">Web scrawler, ticket buying as a case study</a><ul>
<li>
<a aria-label="Preparation: python venv" href="#preparation-python-venv">Preparation: python venv</a></li></ul>
</li>
<li>
<a aria-label="Some known issue about selenium" href="#some-known-issue-about-selenium">Some known issue about selenium</a></li>
<li>
<a aria-label="Utils functions" href="#utils-functions">Utils functions</a></li>
<li>
<a aria-label="lxml html xpath with requests" href="#lxml-html-xpath-with-requests">lxml html xpath with requests</a></li>
<li>
<a aria-label="multiprocessing with tqdm" href="#multiprocessing-with-tqdm">multiprocessing with tqdm</a>
</li>
</ul>
</div>
</details>
</div>
<div class="post-content"><p>[TOC]</p>
<ol>
<li>Title: Web Scrawler Using Selenium 2023</li>
<li>Review Date: Thu, Jun 22, 2023</li>
</ol>
<h2 id="web-scrawler-ticket-buying-as-a-case-study">Web scrawler, ticket buying as a case study<a aria-hidden="true" class="anchor" hidden="" href="#web-scrawler-ticket-buying-as-a-case-study">#</a></h2>
<h3 id="preparation-python-venv">Preparation: python venv<a aria-hidden="true" class="anchor" hidden="" href="#preparation-python-venv">#</a></h3>
<ul>
<li>check <a href="https://www.youtube.com/watch?v=Kg1Yvry_Ydk">https://www.youtube.com/watch?v=Kg1Yvry_Ydk</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python -m venv venv
</span></span><span class="line"><span class="cl"><span class="nb">source</span> venv/bin/activate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># install the following using pip </span>
</span></span><span class="line"><span class="cl"><span class="nv">selenium</span><span class="o">==</span>4.9.1
</span></span><span class="line"><span class="cl">undetected-chromedriver&gt;<span class="o">=</span>3.4.6
</span></span><span class="line"><span class="cl">webdriver-manager
</span></span><span class="line"><span class="cl">jupyterlab
</span></span><span class="line"><span class="cl">pyopenssl
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>known where is the Google Chrome user file location</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">MAC ~/Library/Application Support/Google/Chrome
</span></span><span class="line"><span class="cl">Linux ~/.config/google-chrome
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># load options</span>
</span></span><span class="line"><span class="cl"><span class="n">options</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">ChromeOptions</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">options</span><span class="o">.</span><span class="n">page_load_strategy</span> <span class="o">=</span> <span class="s1">'eager'</span>
</span></span><span class="line"><span class="cl"><span class="c1"># options.add_argument("--auto-open-devtools-for-tabs") # help to avoid cloudfare human verify check</span>
</span></span><span class="line"><span class="cl"><span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--disable-popup-blocking"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--window-size=800,600"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--start-maximized"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--disable-gpu'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--no-sandbox"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--disable-setuid-sandbox"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--disable-extensions"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--disable-application-cache'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--disable-dev-shm-usage"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">HEADLESS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">"--headless=new"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># check os system</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"posix"</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># wait for chrome profile to be ready</span>
</span></span><span class="line"><span class="cl">        <span class="n">driver</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">Chrome</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">driver_executable_path</span><span class="o">=</span><span class="n">ChromeDriverManager</span><span class="p">()</span><span class="o">.</span><span class="n">install</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">user_data_dir</span><span class="o">=</span><span class="n">chrome_profile_path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># version_main=VERSION,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">user_multi_procs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"nt"</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># wait for chrome profile to be ready</span>
</span></span><span class="line"><span class="cl">        <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="sa">f</span><span class="s2">"--user-data-dir=</span><span class="si">{</span><span class="n">chrome_profile_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">driver</span> <span class="o">=</span> <span class="n">uc</span><span class="o">.</span><span class="n">Chrome</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">driver_executable_path</span><span class="o">=</span><span class="n">ChromeDriverManager</span><span class="p">()</span><span class="o">.</span><span class="n">install</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">#    driver_executable_path=os.path.join(os.path.abspath(os.getcwd()), 'chromedriver-win64/chromedriver-win64/chromedriver.exe'),</span>
</span></span><span class="line"><span class="cl">                           <span class="n">user_multi_procs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Unknown OS"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">driver</span><span class="o">.</span><span class="n">implicitly_wait</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="some-known-issue-about-selenium">Some known issue about selenium<a aria-hidden="true" class="anchor" hidden="" href="#some-known-issue-about-selenium">#</a></h2>
<ol>
<li>to avoid memory leak in multiprocessing env, please <strong>import the driver inside the subprocess</strong> (e.g., inside the function)</li>
<li>wait until presence is very slow, <strong>try the sleepy find element</strong></li>
<li>we need to <strong>setup logging queue</strong> to avoid crash for multiprocessing logging module</li>
<li><code>list(tqdm(pool.imap(*), total = len(*)))</code> is a good way to record multiprocess progress</li>
</ol>
<h2 id="utils-functions">Utils functions<a aria-hidden="true" class="anchor" hidden="" href="#utils-functions">#</a></h2>
<ul>
<li>sleep find element</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sleepy_find_element</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">attempt_count</span> <span class="p">:</span><span class="nb">int</span> <span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">sleep_duration</span> <span class="o">=</span><span class="mf">0.3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'''
</span></span></span><span class="line"><span class="cl"><span class="s1">    Finds the web element using the locator and query.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    This function attempts to find the element multiple times with a specified
</span></span></span><span class="line"><span class="cl"><span class="s1">    sleep duration between attempts. If the element is found, the function returns the element.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s1">        by (selenium.webdriver.common.by.By): The method used to locate the element.
</span></span></span><span class="line"><span class="cl"><span class="s1">        query (str): The query string to locate the element.
</span></span></span><span class="line"><span class="cl"><span class="s1">        attempt_count (int, optional): The number of attempts to find the element. Default: 20.
</span></span></span><span class="line"><span class="cl"><span class="s1">        sleep_duration (int, optional): The duration to sleep between attempts. Default: 1.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s1">        selenium.webdriver.remote.webelement.WebElement: Web element or None if not found.
</span></span></span><span class="line"><span class="cl"><span class="s1">    '''</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">browser</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">attempt_count</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span> <span class="o">=</span> <span class="n">browser</span><span class="o">.</span><span class="n">find_elements</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Element </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s1"> has found'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Element </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s1"> is not present, attempt: </span><span class="si">{</span><span class="n">_count</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_duration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"Element not find!"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">item</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>move to element</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># import Action chains</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">selenium.webdriver</span> <span class="kn">import</span> <span class="n">ActionChains</span>
</span></span><span class="line"><span class="cl"><span class="c1">#element</span>
</span></span><span class="line"><span class="cl"><span class="n">source</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s2">"name"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#action chain object</span>
</span></span><span class="line"><span class="cl"><span class="n">action</span> <span class="o">=</span> <span class="n">ActionChains</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># move to element operation</span>
</span></span><span class="line"><span class="cl"><span class="n">action</span><span class="o">.</span><span class="n">move_to_element</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">click</span><span class="p">()</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>useful imports</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">selenium.webdriver.common.by</span> <span class="kn">import</span> <span class="n">By</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">selenium.webdriver.common.keys</span> <span class="kn">import</span> <span class="n">Keys</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">selenium.webdriver.support.wait</span> <span class="kn">import</span> <span class="n">WebDriverWait</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">selenium.webdriver.support</span> <span class="kn">import</span> <span class="n">expected_conditions</span> <span class="k">as</span> <span class="n">EC</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">selenium.common.exceptions</span> <span class="kn">import</span> <span class="n">TimeoutException</span><span class="p">,</span> <span class="n">NoSuchElementException</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pickle</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">csv</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="lxml-html-xpath-with-requests">lxml html xpath with requests<a aria-hidden="true" class="anchor" hidden="" href="#lxml-html-xpath-with-requests">#</a></h2>
<ul>
<li>used for requests (simpler and faster in some cases)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">html</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">complete_url</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
</span></span><span class="line"><span class="cl"><span class="n">tree</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="c1"># read byte content</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># print("start loading")</span>
</span></span><span class="line"><span class="cl"><span class="c1"># latitude </span>
</span></span><span class="line"><span class="cl"><span class="n">latitude_xp</span> <span class="o">=</span> <span class="s1">'//h3[contains(text(), "Coordinates")]/following-sibling::p[contains(text(), "Latitude")]'</span>
</span></span><span class="line"><span class="cl"><span class="n">latitude_ele</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">latitude_xp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">latitude_ele</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">latitude_ele</span> <span class="o">=</span> <span class="n">latitude_ele</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">latitude_info</span> <span class="o">=</span> <span class="n">latitude_ele</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"Latitude: "</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print('latitude_info', latitude_info)</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span><span class="p">[</span><span class="s1">'latitude'</span><span class="p">]</span> <span class="o">=</span> <span class="n">latitude_info</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>text_content() will get all the text in the node, which is same as <code>.text</code> in selenium</li>
</ul>
<h2 id="multiprocessing-with-tqdm">multiprocessing with tqdm<a aria-hidden="true" class="anchor" hidden="" href="#multiprocessing-with-tqdm">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma" tabindex="0"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma" tabindex="0"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm.contrib.concurrent</span> <span class="kn">import</span> <span class="n">process_map</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">Lock</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">()</span> <span class="c1"># Manager dictionary must be used for multiprocessing</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># m_saved_postcode_lst = manager.list(saved_postcode_lst)</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># m_no_data_lst = manager.list(no_data_lst)</span>
</span></span><span class="line"><span class="cl">  <span class="n">m_chromelock</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="n">m_nodatalock</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="n">m_savedpstcdlock</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">m_profile_path_list</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">profile_path_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># %%</span>
</span></span><span class="line"><span class="cl">  <span class="n">postcode_list_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">postcode_list</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">CHUNK_SIZE</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">postcode_list</span><span class="p">),</span> <span class="n">CHUNK_SIZE</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># %%</span>
</span></span><span class="line"><span class="cl">  <span class="n">args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">m_chromelock</span><span class="p">,</span><span class="n">m_nodatalock</span><span class="p">,</span><span class="n">m_savedpstcdlock</span><span class="p">,</span> <span class="n">m_profile_path_list</span><span class="p">,</span> <span class="n">loggername</span><span class="p">,</span> <span class="n">loggingfile</span><span class="p">,</span> <span class="n">data_index</span><span class="p">)</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">postcode_list_chunks</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">PROCESS_NUM</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">logging_tqdm</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">helperf</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">loggername</span><span class="o">=</span><span class="n">loggername</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">loggingfile</span><span class="o">=</span><span class="n">loggingfile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">desc</span><span class="o">=</span><span class="s2">"Progress Status in Main Process"</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">  <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">active_children</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">active_children</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">active_children</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">p</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">          <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Killing all processes"</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># IMPORTANT we must attach dict to the manager dict, nest dict update is banned in multiprocessing</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">temp</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">"United States"</span><span class="p">:</span> <span class="s2">"New York"</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="s2">"Italy"</span><span class="p">:</span> <span class="s2">"Naples"</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="s2">"England"</span><span class="p">:</span> <span class="s2">"London"</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">postcode_info_dict</span><span class="p">[</span><span class="n">postcode</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span> <span class="c1"># OK</span>
</span></span><span class="line"><span class="cl"><span class="n">postcode_info_dict</span><span class="p">[</span><span class="n">postcode</span><span class="p">][</span><span class="s1">'United States'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"New York"</span> <span class="c1"># BAD</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</div>
<footer class="post-footer">
<ul class="post-tags">
</ul>
<nav class="paginav">
<a class="prev" href="https://sino-huang.github.io/posts/jianning_wang-boosting-language-models-reasoning-with-chain-of-knowledge-prompting-2023/">
<span class="title">« Prev</span>
<br/>
<span>Jianning_wang Boosting Language Models Reasoning With Chain of Knowledge Prompting 2023</span>
</a>
<a class="next" href="https://sino-huang.github.io/posts/lin_guan-leveraging-pretrained-llm-to-construct-and-utilise-world-models-for-model-based-task-planning-2023/">
<span class="title">Next »</span>
<br/>
<span>Lin_guan Leveraging Pretrained Llm to Construct and Utilise World Models for Model Based Task Planning 2023</span>
</a>
</nav>
<ul class="share-buttons">
<li>
<a aria-label="share Web Scrawler Using Selenium 2023 on x" href="https://x.com/intent/tweet/?text=Web%20Scrawler%20Using%20Selenium%202023&amp;url=https%3a%2f%2fsino-huang.github.io%2fprogramming-notes%2fweb-scrawler-using-selenium-2023%2f&amp;hashtags=" rel="noopener noreferrer" target="_blank">
<svg fill="currentColor" height="30px" version="1.1" viewbox="0 0 512 512" width="30px" xml:space="preserve">
<path d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z"></path>
</svg>
</a>
</li>
<li>
<a aria-label="share Web Scrawler Using Selenium 2023 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsino-huang.github.io%2fprogramming-notes%2fweb-scrawler-using-selenium-2023%2f&amp;title=Web%20Scrawler%20Using%20Selenium%202023&amp;summary=Web%20Scrawler%20Using%20Selenium%202023&amp;source=https%3a%2f%2fsino-huang.github.io%2fprogramming-notes%2fweb-scrawler-using-selenium-2023%2f" rel="noopener noreferrer" target="_blank">
<svg fill="currentColor" height="30px" version="1.1" viewbox="0 0 512 512" width="30px" xml:space="preserve">
<path d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z"></path>
</svg>
</a>
</li>
<li>
<a aria-label="share Web Scrawler Using Selenium 2023 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fsino-huang.github.io%2fprogramming-notes%2fweb-scrawler-using-selenium-2023%2f&amp;title=Web%20Scrawler%20Using%20Selenium%202023" rel="noopener noreferrer" target="_blank">
<svg fill="currentColor" height="30px" version="1.1" viewbox="0 0 512 512" width="30px" xml:space="preserve">
<path d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z"></path>
</svg>
</a>
</li>
<li>
<a aria-label="share Web Scrawler Using Selenium 2023 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsino-huang.github.io%2fprogramming-notes%2fweb-scrawler-using-selenium-2023%2f" rel="noopener noreferrer" target="_blank">
<svg fill="currentColor" height="30px" version="1.1" viewbox="0 0 512 512" width="30px" xml:space="preserve">
<path d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z"></path>
</svg>
</a>
</li>
<li>
<a aria-label="share Web Scrawler Using Selenium 2023 on whatsapp" href="https://api.whatsapp.com/send?text=Web%20Scrawler%20Using%20Selenium%202023%20-%20https%3a%2f%2fsino-huang.github.io%2fprogramming-notes%2fweb-scrawler-using-selenium-2023%2f" rel="noopener noreferrer" target="_blank">
<svg fill="currentColor" height="30px" version="1.1" viewbox="0 0 512 512" width="30px" xml:space="preserve">
<path d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z"></path>
</svg>
</a>
</li>
<li>
<a aria-label="share Web Scrawler Using Selenium 2023 on telegram" href="https://telegram.me/share/url?text=Web%20Scrawler%20Using%20Selenium%202023&amp;url=https%3a%2f%2fsino-huang.github.io%2fprogramming-notes%2fweb-scrawler-using-selenium-2023%2f" rel="noopener noreferrer" target="_blank">
<svg fill="currentColor" height="30px" version="1.1" viewbox="2 2 28 28" width="30px" xml:space="preserve">
<path d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z"></path>
</svg>
</a>
</li>
<li>
<a aria-label="share Web Scrawler Using Selenium 2023 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Web%20Scrawler%20Using%20Selenium%202023&amp;u=https%3a%2f%2fsino-huang.github.io%2fprogramming-notes%2fweb-scrawler-using-selenium-2023%2f" rel="noopener noreferrer" target="_blank">
<svg fill="currentColor" height="30px" version="1.1" viewbox="0 0 512 512" width="30px" xml:space="preserve" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
<path d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z"></path>
</svg>
</a>
</li>
</ul>
</footer>
</article>
</main>
<footer class="footer">
<span>© 2024 <a href="https://sino-huang.github.io/">Sukai Huang</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &amp;
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
</span>
</footer>
<a accesskey="g" aria-label="go to top" class="top-link" href="#top" id="top-link" title="Go to Top (Alt + G)">
<svg fill="currentColor" viewbox="0 0 12 6" xmlns="http://www.w3.org/2000/svg">
<path d="M12 6H0l6-6z"></path>
</svg>
</a>
<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>
</html>
